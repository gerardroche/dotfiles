#!/bin/sh

set -e
unset CDPATH
unset IFS

show_usage() {
    cat <<USAGE
Usage: [PROJECTS_PATH=<PATH>] $(basename "$0") [--exclude-sessions] [--exclude-workspaces]

Removes files generated by Sublime Text.

Example: caches, indexes, workspaces, sessions, etc.

It does not remove installed packages, configuration files, license, etc.

By default, and unless --exclude-workspaces options is set, workspaces in the
following locations are removed:

- ./*.sublime-workspace
- ./*/*.sublime-workspace

If the PROJECTS_PATH environment variable is set, then workspaces in the
following locations are also removed:

- ./*.sublime-workspace
- ./*/*.sublime-workspace
- ~/projects/*.sublime-workspace
- ~/projects/*/*.sublime-workspace
- ~/projects/*/*/*.sublime-workspace
- ~/projects/.{sublime,st}-projects/*.sublime-workspace
- ~/projects/.{sublime,st}-workspaces/*.sublime-workspace
- ~/projects/.{sublime,st}/*.sublime-workspace

Examples:

    $ sublime-clean
    $ sublime-clean --exclude-sessions
    $ sublime-clean --exclude-workspaces
    $ sublime-clean --exclude-sessions --exlude-workspaces

    $ PROJECTS_PATH=~/projects sublime-clean
    $ PROJECTS_PATH=~/projects sublime-clean --exclude-sessions
    $ PROJECTS_PATH=~/projects sublime-clean --exclude-workspaces
    $ PROJECTS_PATH=~/projects sublime-clean --exclude-sessions --exlude-workspaces

USAGE
}

SUBLIME_CLEAN_INCLUDE_SESSIONS=y
SUBLIME_CLEAN_INCLUDE_WORKSPACES=y
while test "$#" != 0; do
    case "$1" in
        --help|-h) show_usage; exit 0 ;;
        --exclude-sessions) SUBLIME_CLEAN_INCLUDE_SESSIONS= ;;
        --exclude-workspaces) SUBLIME_CLEAN_INCLUDE_WORKSPACES= ;;
        --) shift; break ;; # standard end of options list
        -*) echo >&2 "$(basename "$0"): unknown option '$1'"; exit 1 ;;
        *) echo >&2 "$(basename "$0"): unknown argument '$1'"; exit 1 ;;
    esac
    shift
done

if test -n "$(pgrep -f "(subl.*\/plugin_host [0-9]+$|^subl$)")"; then
  echo >&2 "ERROR: Cannot clean while Sublime Text is running."
  echo >&2 "ERROR: Please close Sublime Text and run script again."
  exit 1
fi

echo "Clean Sublime Text 2 ..."

# ST2 Linux
rm -rfv ~/.config/sublime-text-2/Installed\ Packages/
rm -rfv ~/.config/sublime-text-2/Packages/
rm -rfv ~/.config/sublime-text-2/Pristine\ Packages/

# ST2 OSX
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 2/Installed\ Packages/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 2/Packages/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 2/Pristine\ Packages/

if [ "$SUBLIME_CLEAN_INCLUDE_SESSIONS" = "y" ]; then
    # ST2 Linux sessions
    rm -fv ~/.config/sublime-text-2/Settings/*.sublime_session
    # ST2 OSX sessions
    rm -fv ~/Library/Application\ Support/Sublime\ Text\ 2/Settings/*.sublime_session
fi

rmdir_if_empty() {
    if test -d "$1"; then
        rmdir "$1" || true
        echo "Remove empty directory '$1'"
    fi
}

echo "Clean Sublime Text 3 ..."

# ST3 & ST4
rm -rfv ~/.cache/sublime-text*/Crash\ Reports/
rm -rfv ~/.cache/sublime-text*/Package\ Storage/
rm -rfv ~/.config/sublime-text*/Backup/
rm -rfv ~/.config/sublime-text*/Cache/
rm -rfv ~/.config/sublime-text*/Index/
rm -rfv ~/.config/sublime-text*/Log/
rm -rfv ~/.config/sublime-text*/Packages/.logs/
rm -rfv ~/.config/sublime-text*/Packages/User/*.log*
rm -rfv ~/.config/sublime-text*/Packages/User/Color\ Highlighter/icons/
rm -rfv ~/.config/sublime-text*/Packages/User/Package\ Control.*-ca-bundle
rm -rfv ~/.config/sublime-text*/Packages/User/Package\ Control.cache/
rm -rfv ~/.config/sublime-text*/Packages/User/SublimeLinter/*.tmTheme
rm -rfv ~/.config/sublime-text*/Packages/User/UnitTesting/
rm -rfv ~/.config/sublime-text*/Settings/
rmdir_if_empty ~/.config/sublime-text-3/Lib/python3.3/
rmdir_if_empty ~/.config/sublime-text-3/Lib/python3.8/
rmdir_if_empty ~/.config/sublime-text-3/Lib/python33/
rmdir_if_empty ~/.config/sublime-text-3/Lib/python38/
rmdir_if_empty ~/.config/sublime-text-3/Lib/
rmdir_if_empty ~/.config/sublime-text-3/Packages/User/Color\ Highlighter/
rmdir_if_empty ~/.config/sublime-text-3/Packages/User/SublimeLinter/
rmdir_if_empty ~/.config/sublime-text/Lib/python3.3/
rmdir_if_empty ~/.config/sublime-text/Lib/python3.8/
rmdir_if_empty ~/.config/sublime-text/Lib/python33/
rmdir_if_empty ~/.config/sublime-text/Lib/python38/
rmdir_if_empty ~/.config/sublime-text/Lib/
rmdir_if_empty ~/.config/sublime-text/Log/
rmdir_if_empty ~/.config/sublime-text/Packages/User/Color\ Highlighter/
rmdir_if_empty ~/.config/sublime-text/Packages/User/SublimeLinter/

# ST4 caches
rm -rfv ~/.cache/sublime-text/Cache/
rm -rfv ~/.cache/sublime-text/Index/

# OSX ST3
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Backup/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Cache/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Index/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/.logs/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/Package\ Control.*-ca-bundle
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/User/*.log*
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/User/Color\ Highlighter/icons/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/User/Package\ Control.cache/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/User/SublimeLinter/*.tmTheme
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/User/UnitTesting/
rm -rfv ~/Library/Application\ Support/Sublime\ Text\ 3/Settings/
rmdir_if_empty ~/Library/Application\ Support/Sublime\ Text\ 3/Lib/python3.3/
rmdir_if_empty ~/Library/Application\ Support/Sublime\ Text\ 3/Lib/
rmdir_if_empty ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/User/Color\ Highligher/
rmdir_if_empty ~/Library/Application\ Support/Sublime\ Text\ 3/Packages/User/SublimeLinter/

if [ "$SUBLIME_CLEAN_INCLUDE_SESSIONS" = "y" ]; then
    echo "Clean Sublime Text sessions ..."
    # ST3 Linux sessions
    rm -fv ~/.config/sublime-text-3/Local/*.sublime_session
    # ST4 Linux sessions
    rm -fv ~/.config/sublime-text/Local/*.sublime_session
    # ST3 OSX sessions
    rm -fv ~/Library/Application\ Support/Sublime\ Text\ 3/Local/*.sublime_session
    # NeoVintageous
    rm -rfv ~/.config/sublime-text*/Local/nvinfo
fi

if [ "$SUBLIME_CLEAN_INCLUDE_WORKSPACES" = "y" ]; then
    echo "Clean Sublime Text workspaces ..."
    rm -fv ./*.sublime-workspace
    rm -fv ./*/*.sublime-workspace
    if [ -d "$PROJECTS_PATH" ]; then

        rm -fv "$PROJECTS_PATH"/*.sublime-workspace
        rm -fv "$PROJECTS_PATH"/.reload-package
        rm -rfv "$PROJECTS_PATH"/.mypy_cache/
        rm -rfv "$PROJECTS_PATH"/.rope_project/

        rm -fv "$PROJECTS_PATH"/*/*.sublime-workspace
        rm -fv "$PROJECTS_PATH"/*/.reload-package
        rm -rfv "$PROJECTS_PATH"/*/.mypy_cache/
        rm -rfv "$PROJECTS_PATH"/*/.rope_project/

        rm -fv "$PROJECTS_PATH"/*/*/*.sublime-workspace
        rm -fv "$PROJECTS_PATH"/*/*/.reload-package
        rm -rfv "$PROJECTS_PATH"/*/*/.mypy_cache/
        rm -rfv "$PROJECTS_PATH"/*/*/.rope_project/

        rm -fv "$PROJECTS_PATH"/.sublime/*.sublime-workspace
        rm -fv "$PROJECTS_PATH"/.sublime-workspaces/*.sublime-workspace
        rm -fv "$PROJECTS_PATH"/.sublime-projects/*.sublime-workspace
        rm -fv "$PROJECTS_PATH"/.st/*.sublime-workspace
        rm -fv "$PROJECTS_PATH"/.st-workspaces/*.sublime-workspace
        rm -fv "$PROJECTS_PATH"/.st-projects/*.sublime-workspace
    fi
fi

echo "Done cleaning Sublime Text."
